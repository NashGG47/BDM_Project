import geopandas as gpd
import pandas as pd
import folium
from shapely.geometry import Point
from influxdb_client import InfluxDBClient
from shapely import wkt

PARQUET_FILE = "storage/delta/raw/administrative_shapefiles/202505/20250512/part-00007-164285a9-9a85-49f1-9b6f-e1aa4a1ce683-c000.snappy.parquet"
INFLUX_URL = "http://localhost:8086"
INFLUX_TOKEN = "token1"
INFLUX_ORG = "upa"
INFLUX_AQ_BUCKET = "air_quality"
INFLUX_INC_BUCKET = "gencat_incident_clusters"


def query_air_quality():
    client = InfluxDBClient(url=INFLUX_URL, token=INFLUX_TOKEN, org=INFLUX_ORG)
    query = f'''
    from(bucket: "{INFLUX_AQ_BUCKET}")
        |> range(start: 0)
        |> filter(fn: (r) => r._measurement == "emissions")
        |> pivot(rowKey:["_time"], columnKey: ["_field"], valueColumn: "_value")
        |> keep(columns: ["_time", "average_contaminant", "latitud", "longitud", "contaminant", "nom_estacio"])
    '''
    tables = client.query_api().query(query)
    results = []
    for table in tables:
        for record in table.records:
            results.append({
                "lat": record.values.get("latitud"),
                "lon": record.values.get("longitud"),
                "value": record.values.get("average_contaminant"),
                "station": record.values.get("nom_estacio"),
                "contaminant": record.values.get("contaminant")
            })
    client.close()
    return pd.DataFrame(results)


def query_incident_clusters():
    client = InfluxDBClient(url=INFLUX_URL, token=INFLUX_TOKEN, org=INFLUX_ORG)
    query = f'''
    from(bucket: "{INFLUX_INC_BUCKET}")
      |> range(start: 0)
      |> filter(fn: (r) => r._measurement == "incident_clusters")
      |> pivot(rowKey:["_time"], columnKey: ["_field"], valueColumn: "_value")
      |> keep(columns: ["_time", "road", "cause", "incident_count", "lat", "lon"])
    '''
    tables = client.query_api().query(query)
    results = []
    for table in tables:
        for record in table.records:
            results.append({
                "time": record.values.get("_time"),
                "road": record.values.get("road"),
                "cause": record.values.get("cause"),
                "incident_count": record.values.get("incident_count"),
                "lat": record.values.get("lat"),
                "lon": record.values.get("lon"),
            })
    client.close()
    return pd.DataFrame(results)


def load_shapefile(parquet_path):
    df = pd.read_parquet(parquet_path)

    if "geometry" in df.columns:
        print("Geom found.")
        gdf = gpd.GeoDataFrame(df, geometry="geometry", crs="EPSG:4326")

    elif {"longitud", "latitud"}.issubset(df.columns):
        print("Creating geom.")
        df["geometry"] = df.apply(lambda row: Point(row["longitud"], row["latitud"]), axis=1)
        gdf = gpd.GeoDataFrame(df, geometry="geometry", crs="EPSG:4326")

    elif "geometry_wkt" in df.columns:
        print("Parsing WKT to geometry.")
        df["geometry"] = df["geometry_wkt"].apply(wkt.loads)
        gdf = gpd.GeoDataFrame(df, geometry="geometry", crs="EPSG:4326")

    else:
        print(f"Error: columns found = {df.columns.tolist()}")
        raise ValueError("The Parquet file must contain a 'geometry' column, a 'geometry_wkt' column, or both 'latitud' and 'longitud'.")

    return gdf


gdf_shape = load_shapefile(PARQUET_FILE)
df_aq = query_air_quality()
df_inc = query_incident_clusters()

m = folium.Map(location=[41.4, 2.16], zoom_start=8)
folium.GeoJson(gdf_shape.to_json(), name="Administrative Zones").add_to(m)

for _, row in df_aq.iterrows():
    folium.CircleMarker(
        location=[row["lat"], row["lon"]],
        radius=6,
        popup=f'{row["station"]} ({row["contaminant"]}): {row["value"]:.1f} µg/m³',
        color="red",
        fill=True,
        fill_opacity=0.7,
    ).add_to(m)


for _, row in df_inc.iterrows():
    folium.CircleMarker(
        location=[row["lat"], row["lon"]],
        radius=7,
        popup=(f'Road: {row["road"]}<br>'
               f'Cause: {row["cause"]}<br>'
               f'Incidents: {int(row["incident_count"])}'),
        color="blue",
        fill=True,
        fill_opacity=0.6,
    ).add_to(m)
#like css
legend_html = '''
     <div style="
     position: fixed; 
     bottom: 50px; left: 50px; width: 180px; height: 90px; 
     background-color: white;
     border:2px solid grey; 
     z-index:9999; 
     font-size:14px;
     padding: 10px;
     box-shadow: 3px 3px 6px rgba(0,0,0,0.3);
     ">
     <b>Legend</b><br>
     <i style="background: red; border-radius: 50%; width: 12px; height: 12px; display: inline-block;"></i> Air Quality<br>
     <i style="background: blue; border-radius: 50%; width: 12px; height: 12px; display: inline-block;"></i> Incident Clusters
     </div>
     '''

m.get_root().html.add_child(folium.Element(legend_html))

m.save("exploitation_zone/emissions_map/combined_map.html")
print("Map saved as exploitation_zone/emissions_map/combined_map.html")
